<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>小雪</title>
        <link rel="stylesheet" href="css/style.css">
        <script>
            function openSettings() {
                document.getElementById('settingsModal').classList.add('active');
            }
            function openMemory() {
                document.getElementById('memoryModal').classList.add('active');
            }
            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
            function openChangelog() {
                document.getElementById('changelogModal').classList.add('active');
            }

        </script>
    </head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-left">
                <div class="avatar" id="mainAvatar">💕</div>
                <div class="header-info">
                        <div class="name" id="charName">小雪</div>
                        <div class="status">在线</div>
                        <div class="version" onclick="openChangelog()" style="cursor: pointer;">v2.95</div>
                    </div>
            </div>
            <div class="header-right">
                <button class="icon-btn" id="saveBtn" title="快速存档" onclick="quickSave()">💾</button>
                <button class="icon-btn" id="loadBtn" title="存档管理" onclick="openSaveManager()">📁</button>
                <button class="icon-btn" id="memoryBtn" title="长期记忆" onclick="openMemory()">🧠</button>
                <button class="icon-btn" id="settingsBtn" title="设置" onclick="openSettings()">⚙️</button>
            </div>
        </header>
        <div class="scene-bar" id="sceneBar">
            <span class="scene-icon">🌸</span>
            <span class="scene-text" id="sceneText"></span>
        </div>

        <main class="chat-container" id="chatContainer">
            <div class="messages" id="messages">
                <div class="message ai" data-message-id="1">
                    <div class="bubble">
                        <span class="text">你好呀！今天过得怎么样？有什么想和我聊聊的吗？😊</span>
                        <span class="memory-indicator" title="重要记忆">⭐</span>
                    </div>
                    <div class="time">刚刚</div>
                </div>
            </div>
        </main>

        <footer class="input-area">
            <div class="input-wrapper">
                <textarea id="messageInput" placeholder="输入消息..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn">发送</button>
            </div>
        </footer>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置</h2>
                <button class="close-btn" id="closeSettings" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>API 设置</h3>
                    <div class="form-group">
                        <label>DeepSeek API 密钥</label>
                        <input type="password" id="apiKey" placeholder="sk-xxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label>模型选择</label>
                        <select id="modelSelect">
                            <option value="deepseek-chat">DeepSeek-V3 (推荐)</option>
                            <option value="deepseek-reasoner">DeepSeek-R1 (深度思考)</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>角色设置</h3>
                    <div class="avatar-settings">
                        <div class="avatar-preview">
                            <div class="avatar-large" id="avatarPreview">💕</div>
                            <button type="button" id="applyAvatarBtn" class="apply-avatar-btn">应用头像</button>
                        </div>
                        <div class="avatar-upload-options">
                            <div class="form-group">
                                <label>上传头像</label>
                                <input type="file" id="avatarInput" accept="image/*">
                                <small>支持 JPG、PNG、GIF，建议小于100KB</small>
                            </div>
                            <div class="form-group">
                                <label>或使用图片URL</label>
                                <input type="text" id="avatarUrl" placeholder="https://example.com/avatar.jpg">
                            </div>
                            <div class="form-group">
                                <label>或使用Emoji</label>
                                <input type="text" id="avatarEmoji" placeholder="💕" maxlength="4">
                            </div>
                            <button type="button" id="resetAvatarBtn" class="reset-avatar-btn">恢复默认</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>她的名字</label>
                        <input type="text" id="charNameInput" placeholder="小雪">
                    </div>
                    <div class="form-group">
                        <label>性格类型</label>
                        <select id="personalitySelect">
                            <option value="gentle">温柔体贴</option>
                            <option value="lively">活泼开朗</option>
                            <option value="mature">成熟稳重</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>说话风格</label>
                        <select id="styleSelect">
                            <option value="sweet">甜美可爱</option>
                            <option value="elegant">优雅知性</option>
                            <option value="playful">俏皮幽默</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>她怎么称呼你</label>
                        <input type="text" id="userNameInput" placeholder="亲爱的">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>外观设置</h3>
                    <div class="form-group">
                        <label>主题</label>
                        <select id="themeSelect">
                            <option value="blue">蓝色（默认）</option>
                            <option value="pink">粉色</option>
                            <option value="green">绿色</option>
                            <option value="dark">深色模式</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>语音设置</h3>
                    <div class="form-group">
                        <label>语音开关</label>
                        <label class="switch">
                            <input type="checkbox" id="ttsEnabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>自动播放语音</label>
                        <label class="switch">
                            <input type="checkbox" id="ttsAutoPlay" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>选择声音</label>
                        <div class="voice-select-wrapper">
                            <select id="ttsVoice">
                                <option value="auto">自动选择（推荐）</option>
                            </select>
                            <button type="button" id="testVoiceBtn" class="test-voice-btn" title="试听">🔊</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>语速</label>
                        <input type="range" id="ttsRate" min="0.5" max="2" step="0.1" value="1">
                        <span id="ttsRateValue">1.0x</span>
                    </div>
                    <div class="form-group">
                        <label>音调</label>
                        <input type="range" id="ttsPitch" min="0.5" max="2" step="0.1" value="1.2">
                        <span id="ttsPitchValue">1.2</span>
                    </div>
                    <div class="form-group">
                        <label>情感语音</label>
                        <label class="switch">
                            <input type="checkbox" id="ttsEmotion" checked>
                            <span class="slider"></span>
                        </label>
                        <small class="setting-hint">根据对话内容自动调整语速和音调</small>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>对话设置</h3>
                    <div class="form-group">
                        <label>连续消息条数</label>
                        <select id="multiMessageCount">
                            <option value="1">1条（传统模式）</option>
                            <option value="2">1-2条</option>
                            <option value="3">1-3条</option>
                            <option value="4">1-4条</option>
                            <option value="5">1-5条</option>
                            <option value="6">1-6条</option>
                            <option value="7">1-7条</option>
                            <option value="8" selected>1-8条（推荐）</option>
                        </select>
                        <small class="setting-hint">让AI一次发送多条消息，更自然</small>
                    </div>
                    <div class="form-group">
                        <label>消息间隔时间</label>
                        <input type="range" id="messageDelay" min="300" max="1500" step="100" value="600">
                        <span id="messageDelayValue">0.6秒</span>
                        <small class="setting-hint">多条消息之间的显示间隔</small>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>外部TTS API <small class="section-hint">（可选，更高质量）</small></h3>
                    <div class="form-group">
                        <label>启用外部API</label>
                        <label class="switch">
                            <input type="checkbox" id="ttsApiEnabled">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="ttsApiConfig" class="tts-api-config" style="display:none;">
                        <div class="form-group">
                            <label>TTS平台</label>
                            <select id="ttsProvider">
                                <option value="browser">浏览器原生（免费）</option>
                                <option value="openai">OpenAI TTS</option>
                                <option value="azure">Azure TTS（微软）</option>
                                <option value="tencent">腾讯云 TTS</option>
                                <option value="aliyun">阿里云 TTS</option>
                                <option value="volcengine">火山引擎 TTS</option>
                                <option value="xfyun">讯飞 TTS</option>
                                <option value="elevenlabs">ElevenLabs</option>
                                <option value="custom">自定义API</option>
                            </select>
                        </div>
                        
                        <div id="ttsApiCommonConfig">
                            <div class="form-group" id="ttsApiKeyGroup">
                                <label>API密钥</label>
                                <input type="password" id="ttsApiKey" placeholder="输入API密钥">
                            </div>
                            <div class="form-group" id="ttsApiVoiceGroup">
                                <label>声音</label>
                                <select id="ttsApiVoice"></select>
                            </div>
                        </div>

                        <div id="ttsExtraConfig"></div>

                        <div id="ttsCustomConfig" style="display:none;">
                            <div class="form-group">
                                <label>API端点</label>
                                <input type="text" id="ttsEndpoint" placeholder="https://api.example.com/tts">
                            </div>
                            <div class="form-group">
                                <label>自定义请求头（JSON）</label>
                                <textarea id="ttsCustomHeaders" rows="2" placeholder='{"Authorization": "Bearer {apiKey}"}'></textarea>
                            </div>
                            <div class="form-group">
                                <label>请求体模板（JSON）</label>
                                <textarea id="ttsCustomBody" rows="3" placeholder='{"text": "{text}", "voice": "{voice}"}'></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="button" id="testTtsApiBtn" class="test-btn">🔊 测试连接</button>
                            <span id="ttsTestResult"></span>
                        </div>
                    </div>
                </div>

                <button class="save-btn" id="saveSettings">保存设置</button>
            </div>
        </div>
    </div>

    <div class="modal" id="memoryModal">
        <div class="modal-content memory-modal">
            <div class="modal-header">
                <h2>长期记忆</h2>
                <button class="close-btn" id="closeMemory" onclick="closeModal('memoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="memory-tabs">
                    <button class="tab-btn active" data-tab="timeline">时间轴</button>
                    <button class="tab-btn" data-tab="important">重要记忆</button>
                    <button class="tab-btn" data-tab="profile">用户档案</button>
                    <button class="tab-btn" data-tab="add">添加记忆</button>
                </div>
                <div class="tab-content active" id="timelineTab">
                    <div class="memory-timeline" id="memoryTimeline">
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-time">今天</div>
                                <div class="memory-card">
                                    <div class="memory-header">
                                        <span class="memory-title">初次见面</span>
                                        <span class="memory-indicator">⭐</span>
                                    </div>
                                    <div class="memory-body">
                                        <p>你好呀！今天过得怎么样？有什么想和我聊聊的吗？😊</p>
                                    </div>
                                    <div class="memory-footer">
                                        <button class="edit-btn">编辑</button>
                                        <button class="delete-btn">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="importantTab">
                    <div class="important-memories" id="importantMemories">
                        <div class="memory-card">
                            <div class="memory-header">
                                <span class="memory-title">重要记忆</span>
                                <span class="memory-indicator">⭐</span>
                            </div>
                            <div class="memory-body">
                                <p>这是一条重要的记忆内容，会被优先存储和检索。</p>
                            </div>
                            <div class="memory-footer">
                                <button class="edit-btn">编辑</button>
                                <button class="delete-btn">删除</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="profileTab">
                    <div class="user-profile" id="userProfile">
                        <div class="profile-card">
                            <div class="profile-header">
                                <h3>用户档案</h3>
                                <button class="edit-profile-btn">编辑</button>
                            </div>
                            <div class="profile-body">
                                <div class="profile-item">
                                    <label>姓名</label>
                                    <span>亲爱的</span>
                                </div>
                                <div class="profile-item">
                                    <label>生日</label>
                                    <span>未设置</span>
                                </div>
                                <div class="profile-item">
                                    <label>职业</label>
                                    <span>未设置</span>
                                </div>
                                <div class="profile-item">
                                    <label>爱好</label>
                                    <span>未设置</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="addTab">
                    <div class="add-memory-form">
                        <h3>添加新记忆</h3>
                        <div class="form-group">
                            <label>记忆标题</label>
                            <input type="text" id="memoryTitle" placeholder="输入记忆标题">
                        </div>
                        <div class="form-group">
                            <label>记忆内容</label>
                            <textarea id="memoryContent" placeholder="输入记忆内容" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label>记忆分类</label>
                            <select id="memoryCategory">
                                <option value="personal">个人信息</option>
                                <option value="preference">偏好</option>
                                <option value="event">重要事件</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <button class="save-btn" id="saveMemory">保存记忆</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="long-press-menu" id="longPressMenu">
        <ul>
            <li data-action="add-to-memory">添加到永久记忆</li>
            <li data-action="view-details">查看详情</li>
            <li data-action="copy">复制内容</li>
            <li data-action="delete">删除消息</li>
        </ul>
    </div>

    <div class="modal" id="saveManagerModal">
        <div class="modal-content save-manager-modal">
            <div class="modal-header">
                <h2>存档管理</h2>
                <button class="close-btn" id="closeSaveManager" onclick="closeModal('saveManagerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="save-points-list" id="savePointsList">
                </div>
                <div class="save-actions">
                    <button class="save-btn" onclick="createNewSave()">新建存档</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="avatarCropModal">
        <div class="modal-content avatar-crop-modal">
            <div class="modal-header">
                <h2>裁剪头像</h2>
                <button class="close-btn" onclick="closeModal('avatarCropModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="crop-container">
                    <div class="crop-preview-area">
                        <div class="crop-canvas-wrapper">
                            <canvas id="cropCanvas"></canvas>
                            <div class="crop-circle-overlay"></div>
                            <div class="crop-handle crop-handle-nw" data-handle="nw"></div>
                            <div class="crop-handle crop-handle-ne" data-handle="ne"></div>
                            <div class="crop-handle crop-handle-sw" data-handle="sw"></div>
                            <div class="crop-handle crop-handle-se" data-handle="se"></div>
                        </div>
                    </div>
                    <div class="crop-preview-circle">
                        <div class="crop-preview-label">预览</div>
                        <canvas id="cropPreviewCanvas" width="100" height="100"></canvas>
                    </div>
                </div>
                <div class="crop-actions">
                    <button type="button" class="crop-cancel-btn" onclick="closeModal('avatarCropModal')">取消</button>
                    <button type="button" class="crop-confirm-btn" id="confirmCropBtn">确认裁剪</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="changelogModal">
        <div class="modal-content changelog-modal">
            <div class="modal-header">
                <h2>版本更新记录</h2>
                <button class="close-btn" onclick="closeModal('changelogModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="changelog-list">
                    <div class="changelog-item">
                        <div class="changelog-version">v2.95</div>
                        <div class="changelog-date">2025-02-22</div>
                        <ul class="changelog-changes">
                            <li>场景栏与顶栏一体化设计</li>
                            <li>背景改为卡片色，加边框分隔</li>
                            <li>移除场景图标，文字居中显示</li>
                            <li>字体增大至17px，更清晰</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.94</div>
                        <div class="changelog-date">2025-02-22</div>
                        <ul class="changelog-changes">
                            <li>场景栏固定在头像下方</li>
                            <li>宽度与页面等宽</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.93</div>
                        <div class="changelog-date">2025-02-22</div>
                        <ul class="changelog-changes">
                            <li>场景气泡改为只显示当前一个</li>
                            <li>位置移到头像下方</li>
                            <li>字体增大，淡入淡出动画</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.92</div>
                        <div class="changelog-date">2025-02-22</div>
                        <ul class="changelog-changes">
                            <li>去掉打字动画效果，消息立即呈现</li>
                            <li>提升响应速度，无延迟显示</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.91</div>
                        <div class="changelog-date">2025-02-22</div>
                        <ul class="changelog-changes">
                            <li>发送区重新设计：方形风格</li>
                            <li>发送按钮最大化，更易点击</li>
                            <li>输入框边框加粗，视觉更清晰</li>
                            <li>按钮渐变色效果，更有质感</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.9</div>
                        <div class="changelog-date">2025-02-22</div>
                        <ul class="changelog-changes">
                            <li>场景与语音合并显示在同一个气泡中</li>
                            <li>场景文字用『』包裹，突出显示</li>
                            <li>移除气泡中的所有图标</li>
                            <li>优化气泡内场景和语音的视觉层次</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.8</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>场景描述独立展示，最多8条堆叠显示</li>
                            <li>场景渐入渐出动画效果</li>
                            <li>消息气泡不再显示场景描述</li>
                            <li>连续消息上限提升至8条</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.7</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>新增悬浮场景展示区，场景描述独立显示</li>
                            <li>语音播放时自动同步展示场景</li>
                            <li>消息播放状态动画效果</li>
                            <li>优化语音与场景的交互体验</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.6</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>新增头像自定义功能，支持上传图片、URL或Emoji</li>
                            <li>头像尺寸增大至70px，更清晰展示</li>
                            <li>优化移动端浏览器TTS兼容性</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.56</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>新增头像裁剪功能</li>
                            <li>上传图片后可选择区域裁剪</li>
                            <li>支持拖动和缩放裁剪框</li>
                            <li>实时预览裁剪效果</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.55</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>新增"应用头像"按钮，上传后可直接应用</li>
                            <li>优化头像设置交互体验</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.52</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>修复语音播放时读出方括号内容的问题</li>
                            <li>多个场景描述自动触发消息拆分</li>
                            <li>纯场景描述消息跳过语音播放</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.51</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>优化消息拆分算法，自动处理多个场景描述</li>
                            <li>改进系统提示词，AI更自然地拆分消息</li>
                            <li>场景描述自动独立显示，语音不再读出方括号内容</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.5</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>新增连续消息功能，AI可以一次发送多条消息</li>
                            <li>新增消息间隔时间设置</li>
                            <li>对话更加自然流畅</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.4</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>新增声音选择器，可手动选择系统可用声音</li>
                            <li>新增音调调节功能</li>
                            <li>新增情感语音功能，根据对话内容自动调整语速和音调</li>
                            <li>新增外部TTS API支持（OpenAI/Azure/腾讯/阿里/火山/讯飞/ElevenLabs）</li>
                            <li>支持自定义TTS API配置</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.31</div>
                        <div class="changelog-date">2025-02-21</div>
                        <ul class="changelog-changes">
                            <li>新增版本更新记录页面</li>
                            <li>优化 GitHub Pages 部署配置</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.3</div>
                        <div class="changelog-date">2025-02-20</div>
                        <ul class="changelog-changes">
                            <li>新增语音自动播放功能</li>
                            <li>场景描述与语音分离显示</li>
                            <li>优化消息解析器</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.2</div>
                        <div class="changelog-date">2025-02-19</div>
                        <ul class="changelog-changes">
                            <li>新增存档系统</li>
                            <li>修复存档按钮和显示问题</li>
                            <li>优化用户界面</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v2.0</div>
                        <div class="changelog-date">2025-02-18</div>
                        <ul class="changelog-changes">
                            <li>增强智能记忆系统</li>
                            <li>新增立体人设系统</li>
                            <li>新增自主故事系统</li>
                            <li>新增动态演化系统</li>
                            <li>分层记忆存储（短期/中期/长期）</li>
                        </ul>
                    </div>
                    <div class="changelog-item">
                        <div class="changelog-version">v1.0</div>
                        <div class="changelog-date">2025-02-15</div>
                        <ul class="changelog-changes">
                            <li>基础聊天功能</li>
                            <li>DeepSeek API 集成</li>
                            <li>语音朗读功能</li>
                            <li>主题切换</li>
                            <li>角色设置</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/memory.js"></script>
    <script src="js/api.js"></script>
    <script src="js/tts-provider.js"></script>
    <script src="js/tts.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    <script src="js/avatar-crop.js"></script>
    <script>
        function quickSave() {
            try {
                console.log('开始快速存档...');
                const savePoint = Memory.quickSave();
                console.log('存档结果:', savePoint);
                if (savePoint) {
                    alert('存档成功！');
                    // 刷新存档列表
                    renderSavePoints();
                } else {
                    alert('存档失败！');
                }
            } catch (error) {
                console.error('快速存档失败:', error);
                alert('存档失败：' + error.message);
            }
        }
        function openSaveManager() {
            try {
                console.log('打开存档管理...');
                document.getElementById('saveManagerModal').classList.add('active');
                renderSavePoints();
            } catch (error) {
                console.error('打开存档管理失败:', error);
                alert('打开存档管理失败：' + error.message);
            }
        }
        function renderSavePoints() {
            try {
                console.log('渲染存档列表...');
                const savePoints = Memory.getSavePoints();
                console.log('存档列表:', savePoints);
                const container = document.getElementById('savePointsList');
                
                if (savePoints.length === 0) {
                    container.innerHTML = '<p class="empty-tip">暂无存档</p>';
                    return;
                }
                
                let html = '';
                savePoints.forEach(sp => {
                    const time = new Date(sp.timestamp).toLocaleString('zh-CN');
                    html += `
                        <div class="save-point-card" data-id="${sp.id}">
                            <div class="save-point-header">
                                <span class="save-point-title">${sp.description}</span>
                                <span class="save-point-time">${time}</span>
                            </div>
                            <div class="save-point-info">
                                <span class="save-point-messages">${sp.messageCount}条消息</span>
                            </div>
                            <div class="save-point-actions">
                                <button class="load-btn" onclick="loadSavePoint(${sp.id})">加载</button>
                                <button class="delete-btn" onclick="deleteSavePoint(${sp.id})">删除</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('渲染存档列表失败:', error);
                alert('渲染存档列表失败：' + error.message);
            }
        }
        function createNewSave() {
            try {
                console.log('创建新存档...');
                const description = prompt('请输入存档描述：', '');
                if (description !== null) {
                    const savePoint = Memory.saveGame(description);
                    console.log('新存档结果:', savePoint);
                    if (savePoint) {
                        alert('存档成功！');
                        renderSavePoints();
                    } else {
                        alert('存档失败！');
                    }
                }
            } catch (error) {
                console.error('创建新存档失败:', error);
                alert('创建新存档失败：' + error.message);
            }
        }
        function loadSavePoint(savePointId) {
            if (confirm('确定要加载这个存档吗？当前进度将被覆盖！')) {
                const success = Memory.rollbackToSavePoint(savePointId);
                if (success) {
                    closeModal('saveManagerModal');
                    location.reload();
                }
            }
        }
        function deleteSavePoint(savePointId) {
            if (confirm('确定要删除这个存档吗？')) {
                Memory.deleteSavePoint(savePointId);
                renderSavePoints();
            }
        }
    </script>
</body>
</html>
